import asyncio
from datetime import datetime

from configs import START_AMOUNT, MIN_SPREAD, SHOW_TOP
from bybit_handler import BybitClientAsync
from bestchange_handler import BestChangeClientAsync
from arbitrage_analyzer import ArbitrageAnalyzerAsync


async def main():
    print("=" * 90)
    print("ğŸš€ CRYPTO ARBITRAGE BOT (ASYNC VERSION) â€” CIRCULAR MODE")
    print("=" * 90)

    start_time = datetime.now()
    print(f"â° Ğ’Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°: {start_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ’° ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°: ${START_AMOUNT}")
    print(f"ğŸ“Š ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿Ñ€ĞµĞ´: {MIN_SPREAD}%")
    print(f"ğŸ¯ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ¿: {SHOW_TOP} ÑĞ²ÑĞ·Ğ¾Ğº\n")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 1: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Bybit
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("=" * 90)
    print("ğŸ“Š Ğ¨ĞĞ“ 1: Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ”ĞĞĞĞ«Ğ¥ Ğ¡ BYBIT")
    print("=" * 90)

    async with BybitClientAsync() as bb:
        await bb.load_usdt_pairs()
        print(f"[Bybit] âœ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ {len(bb.usdt_pairs)} Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ°Ñ€ USDT")

        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 20 Ğ¼Ğ¾Ğ½ĞµÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
        coins_preview = ', '.join(sorted(list(bb.coins)[:20]))
        more_coins = f" Ğ¸ ĞµÑ‰Ğµ {len(bb.coins) - 20}" if len(bb.coins) > 20 else ""
        print(f"[Bybit] âœ“ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚Ñ‹ ({len(bb.coins)}): {coins_preview}{more_coins}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¨ĞĞ“ 2: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ BestChange
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print("\n" + "=" * 90)
        print("ğŸ“Š Ğ¨ĞĞ“ 2: Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ BESTCHANGE API v2.0")
        print("=" * 90)

        async with BestChangeClientAsync() as bc:
            print("[BestChange] Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ²Ğ°Ğ»ÑÑ‚...")
            await bc.load_currencies()
            print(f"[BestChange] âœ“ Ğ’ÑĞµĞ³Ğ¾ Ğ²Ğ°Ğ»ÑÑ‚: {len(bc.currencies)}")
            print(f"[BestChange] âœ“ ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚: {len(bc.crypto_currencies)}")

            # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚
            crypto_preview = ', '.join(sorted(list(bc.crypto_currencies.keys())[:20]))
            more_crypto = f" Ğ¸ ĞµÑ‰Ğµ {len(bc.crypto_currencies) - 20}" if len(bc.crypto_currencies) > 20 else ""
            print(f"[BestChange]   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: {crypto_preview}{more_crypto}")

            print("[BestChange] Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ğ¼ĞµĞ½Ğ½Ğ¸ĞºĞ¾Ğ²...")
            await bc.load_exchangers()
            print(f"[BestChange] âœ“ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ¼ĞµĞ½Ğ½Ğ¸ĞºĞ¾Ğ²: {len(bc.changers)}")

            # ĞŸĞµÑ€ĞµÑĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚ Ğ¼ĞµĞ¶Ğ´Ñƒ Bybit Ğ¸ BestChange
            common_tickers = list(bb.coins & set(bc.crypto_currencies.keys()))
            print(f"\n[Analysis] âœ“ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¼Ğ¾Ğ½ĞµÑ‚: {len(common_tickers)}")

            if common_tickers:
                common_preview = ', '.join(sorted(common_tickers[:20]))
                more_common = f" Ğ¸ ĞµÑ‰Ğµ {len(common_tickers) - 20}" if len(common_tickers) > 20 else ""
                print(f"[Analysis]   ĞĞ±Ñ‰Ğ¸Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚Ñ‹: {common_preview}{more_common}")

            if not common_tickers:
                print("\nâŒ ĞĞµÑ‚ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¼Ğ¾Ğ½ĞµÑ‚ Ğ¼ĞµĞ¶Ğ´Ñƒ Bybit Ğ¸ BestChange. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.")
                return

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 3: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºÑƒÑ€ÑĞ¾Ğ² BestChange
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            print("\n" + "=" * 90)
            print("ğŸ“Š Ğ¨ĞĞ“ 3: Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ ĞšĞ£Ğ Ğ¡ĞĞ’ BESTCHANGE (BATCH MODE)")
            print("=" * 90)
            print(f"[BestChange] Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºÑƒÑ€ÑĞ¾Ğ² Ğ´Ğ»Ñ {len(common_tickers)} Ğ¼Ğ¾Ğ½ĞµÑ‚...")
            print("[BestChange] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° (Ğ´Ğ¾ 100 Ğ¿Ğ°Ñ€ Ğ·Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ)")

            await bc.load_rates(common_tickers)

            # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
            total_directions = sum(len(pairs) for pairs in bc.rates.values())
            print(f"[BestChange] âœ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°: {total_directions}")
            print(f"[BestChange] âœ“ Ğ’Ğ°Ğ»ÑÑ‚ Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼Ğ¸ ĞºÑƒÑ€ÑĞ°Ğ¼Ğ¸: {len(bc.rates)}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 4: ĞŸĞ¾Ğ¸ÑĞº Ğ°Ñ€Ğ±Ğ¸Ñ‚Ñ€Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            print("\n" + "=" * 90)
            print("ğŸ” Ğ¨ĞĞ“ 4: ĞŸĞĞ˜Ğ¡Ğš ĞšĞ Ğ£Ğ“ĞĞ’Ğ«Ğ¥ ĞĞ Ğ‘Ğ˜Ğ¢Ğ ĞĞ–ĞĞ«Ğ¥ Ğ’ĞĞ—ĞœĞĞ–ĞĞĞ¡Ğ¢Ğ•Ğ™")
            print("=" * 90 + "\n")

            analyzer = ArbitrageAnalyzerAsync(bb, bc)
            opportunities = await analyzer.find_circular_opportunities(
                start_amount=START_AMOUNT,
                min_spread=MIN_SPREAD,
                top_count=SHOW_TOP
            )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    end_time = datetime.now()
    elapsed = (end_time - start_time).total_seconds()

    print("\n" + "=" * 90)
    print(f"âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° â€” {end_time.strftime('%H:%M:%S')}")
    print(f"â±ï¸  Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: {elapsed:.2f} ÑĞµĞº.")
    print("=" * 90)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nâ›” Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼.")
    except Exception as e:
        print(f"\nâœ— ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: {e}")
        import traceback

        traceback.print_exc()